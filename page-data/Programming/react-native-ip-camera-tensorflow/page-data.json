{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/Programming/react-native-ip-camera-tensorflow/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Zeyu's Blog"}},"markdownRemark":{"id":"eea0b30f-91cd-5c7e-8a15-0ce5d1671634","excerpt":"引子 这篇博客是针对 react-native 学习笔记的一个补充。说起来研究 RN…","html":"<h2>引子</h2>\n<p>这篇博客是针对 react-native 学习笔记的一个补充。说起来研究 RN 也不过半个月左右，我还真是发现别有洞天。之前拿到手的一个需求是，需要在手机本地实时识别一个视频流所拍摄的画面中是否有某种内容。</p>\n<p>在加入项目之初，这个团队已经运行了将近半年的时间。在这半年中，团队成员解决了 <code class=\"language-text\">tensorflow</code> -> <code class=\"language-text\">tflite</code>，自己训练了新的模型；但由于手机自带的摄像头并不能满足拍摄的照片情况，因此在嵌入式端（树莓派），做了一个 MJPEG 的 stream，相当于变成了一个 IP Camera，需要在同网络下 GET ACCESS。</p>\n<p>事实上，tensorflow 官方的 example 中已经实现了 <code class=\"language-text\">手机摄像头实时预测</code>。所以，交到我手上的任务就是把手机摄像头变成 IP Camera。</p>\n<h2>难题</h2>\n<p>于是我开始研究 tf 官方的 example，想着下学期也要学安卓开发，就先熟悉熟悉也不是什么坏事。但看过以后我发现，事情并没有那么简单。</p>\n<p>一方面，安卓使用的东西封装程度过高，比如 camera 实时预测这个东西，<code class=\"language-text\">imageProxy</code> 和被 override 的 <code class=\"language-text\">analyze()</code> 方法合在一起使用，让人无从下手。因为这看起来是手机自带的 camera 才有的接口。所以，如果直接修改安卓代码，也需要从头开始写起 🤔，这可不是个简单的活儿。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9cb91ce51cc17b7fa2f6c3b46ea746da/5b30f/tflite-example.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.24050632911392%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABJElEQVQoz21RW3LEIAzb6yQ8DRhDsp229z+UOnZI9qcfwonHCFl6xZBw8IlT3miVMY4T83ijy8CYB7h35JyRU7rqAhEhpWRV/7332PcdLz2cd3aRmVFrXZeuwZQzSikgKtZTkrTIY4zPAyGED6EOqBoZignuAuaO3juo6iMFtQtSJoTgEVM0MoUSKVShcw4vPbTRmI2gi0AWVHVfEBZwY0gXSB9WW2uPQhVlCrdtMx++f35NWW1stanCMVG5g3JBSQ0UywIhR8LuLt/MNufulR1icJiDIRrI+bZglGyeXxhygquAEpmPlRmZyuVtdEgxgkr9hKLMmwUT0Apb2sLz8XQsUCbbJMb0+Ba8MyIfwkehfmgzWNPD31iDt9lqjeJe8T9oKH/aEfrNy36htgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tflite example\"\n        title=\"tflite example\"\n        src=\"/static/9cb91ce51cc17b7fa2f6c3b46ea746da/f058b/tflite-example.png\"\n        srcset=\"/static/9cb91ce51cc17b7fa2f6c3b46ea746da/c26ae/tflite-example.png 158w,\n/static/9cb91ce51cc17b7fa2f6c3b46ea746da/6bdcf/tflite-example.png 315w,\n/static/9cb91ce51cc17b7fa2f6c3b46ea746da/f058b/tflite-example.png 630w,\n/static/9cb91ce51cc17b7fa2f6c3b46ea746da/40601/tflite-example.png 945w,\n/static/9cb91ce51cc17b7fa2f6c3b46ea746da/78612/tflite-example.png 1260w,\n/static/9cb91ce51cc17b7fa2f6c3b46ea746da/5b30f/tflite-example.png 2372w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>于是我开始在 Github 上大量翻看相关 repo，但遗憾的是，比较优秀的 repo 最多也只能做到 <code class=\"language-text\">静态预测</code>（tflite-react-native），或者 <code class=\"language-text\">手机自带摄像头实时预测</code>（tfjs-react-native）。下面我会一一介绍：</p>\n<h2>tflite-react-native</h2>\n<p>项目地址：<a href=\"https://github.com/shaqian/tflite-react-native\">https://github.com/shaqian/tflite-react-native</a></p>\n<p>该项目将著名的 mobilenet 应用在移动端的模型 <code class=\"language-text\">tflite</code> 移植到了 react-native 平台上。不过已经有将近两年没有更新了，在用 RN 版本大于 0.6 的时候，iOS 方面会出一些配置上的问题。这时就需要手动 link 一下。在项目主人的 example 中，我看到 ta 已经实现了静态图像预测：从手机目录中选取一张图片 （react-native-image-picker），然后给 tflite model 去跑，并返回得到的结果。</p>\n<p>遗憾的是，它不能接受网页 URL 的图片输入，只能接受手机本地。</p>\n<h2>expo</h2>\n<p>官方文档：<a href=\"https://docs.expo.dev/\">https://docs.expo.dev/</a></p>\n<p>是一个基于 RN 的项目 builder 和 sdk 集成环境。还是蛮好用的，省去了很多单独 config 安卓和 iOS 的步骤。直接运行 <code class=\"language-text\">yarn android</code> 或 <code class=\"language-text\">yarn ios</code> 就可以 launch 了，这个效率还是可以的，和 flutter 有得一比。在手机上下载 Expo Go，并扫描 launch 出来的二维码就可以直接在手机上看开发的 App 了。也实现了实时热加载。</p>\n<h2>tfjs-react-native</h2>\n<p>项目地址：<a href=\"https://github.com/tensorflow/tfjs/tree/master/tfjs-react-native\">https://github.com/tensorflow/tfjs/tree/master/tfjs-react-native</a></p>\n<p>API 文档：<a href=\"https://js.tensorflow.org/api_react_native/latest/\">https://js.tensorflow.org/api_react_native/latest/</a></p>\n<p>这是 Tensorflow.js 官方出的针对 react-native 的库。看起来 google 还是比较重视 RN 这块的（flutter 都没有官方的 tf 库）。</p>\n<p>在官方给的 <a href=\"https://github.com/expo/examples/tree/master/with-tfjs-camera\">example</a> 中，它也实现了 <code class=\"language-text\">手机自带摄像头实时预测</code>。但它调用的 Camera 是基于 Expo 实现的，<code class=\"language-text\">onReady</code> 函数是一个回调，用 iterator 不断产生新的 image。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c204e7fac76bd849c946e89096d5c978/d2782/expo-example.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 103.79746835443038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAABYlAAAWJQFJUiTwAAAD10lEQVQ4y5WU/0/UdRzHPwhsHPcFSO5AIzjuC/eNz3353OeOu+M4DjgglYAyFREbzUT7oh0u54wZa2ys3DIbWzFwwU+IK1hAg5kw1JEUa7h0LipKG8vsr3g0rsI11zh+eOz9fj+393PP13vvPYVduyuoqqulOhYjEo0SjlQSqohQHaul7fBLtLa10djUTKSmlqpYHeWRKMFwhLJQ+AkCoTCC1WamsKgIo9GIyWTCYDQmMJnNmEtKErglL6FIlEh1jHC0mnBVzX9Z1/5ByMhQIAgCGRkZZGk0aNRqNBoNarU6oa9T8EwhvkAIj+zD6/PjKwvgDwQ3KAuGCIUr8AfLEdLSUjcu/h86XR42uwNBSHmsb0slJTVtQ1MoVbg8EkJ6evqmhlqdDpfbTVgWCbpKCIoGZEsBLkM+jkItlp3ZWArzcLql9YRpmxrmanXIsszIB29xdfAcI72v8tGJ53m3LcrZfSHOvOCnvU7C4XQna6hF9vm48cWn3PrsIr0djXQfjtHVEub03iDxBg8HoyJ2MUnD7bm5eGUfa7/cY+3767woFdLZ5Ke3vYpTzTKHKsw0Ba24JBkhPZmEudqE4YOV2zz6YZHnPMXEG/3E91exqzJA2C8REYtxebxJjpyrRZK8rCwv8OfKIjWinjebAhxsqKc8UkNlKIjPXEDpVt7Q45FYmv2SP+4u0FLp4tTeSg4crSEUjlIRChKw6beQUKvF7ZG4Nn6ZO7Ofc6TWy7F6mbMdz1LnFwk4TARtepyeJL+NVqvD6XIxc/ljvp28xPkTLfR2NPP+kT2c2VfB0Vo3u/127KXOrRmOfPIelz88R8/xAwz1vMHbh2p5Jebm9d0yDWWlWO1ikoa6POx2B+8ca6W/u5Pu462cbNnD+c524vvraa8PEHWasNhLH3+blJSUJ4z+1fLy8zEZjVy60Mujtd/48d4dlpcWuXv7O9Z+/YmHD1Y5+XIr+mJjcgnz8ndgMBi42NPFw/urLH/zNTfnvuL6tavcunmD3+//TO/p1ygqNvxdDgqFIlFXKpUKpVJJZmZmYl0/p6ZuS7RNicWKVf80HqsRU0E+Fn0B+p35FO7IQ3aYcZcUYbE5EERRZG5ujtHRUa5cucLU1BQTExOMjY2xsLBAV1cXKrUac4l100lsDhEhEAiwsrLC7OwsMzMzTE9PMz8/z9LSEqurq/T19SXSrvehWqVCpVSSk53F9qdy2J6TTZZGjTJTQXaWBrujFMFuszE+Ps7w8DBDQ0P09/czMDDA4OAgk5OTxONxVGoNpR4fdpeEwy0n9qLk38DpLUOUynDKQf4Cd9ih28u58UoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"expo example\"\n        title=\"expo example\"\n        src=\"/static/c204e7fac76bd849c946e89096d5c978/f058b/expo-example.png\"\n        srcset=\"/static/c204e7fac76bd849c946e89096d5c978/c26ae/expo-example.png 158w,\n/static/c204e7fac76bd849c946e89096d5c978/6bdcf/expo-example.png 315w,\n/static/c204e7fac76bd849c946e89096d5c978/f058b/expo-example.png 630w,\n/static/c204e7fac76bd849c946e89096d5c978/40601/expo-example.png 945w,\n/static/c204e7fac76bd849c946e89096d5c978/78612/expo-example.png 1260w,\n/static/c204e7fac76bd849c946e89096d5c978/d2782/expo-example.png 1864w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>不过它最大的问题在于调用它的 await function 似乎需要翻墙。。。难道是 tfjs 的服务挂在了 google colab 上？这一点还不太确定。总而言之，目前它不是一个好的解决方案。</p>\n<h2>react-native-FFmpeg</h2>\n<p>项目地址：<a href=\"https://github.com/tanersener/react-native-ffmpeg\">https://github.com/tanersener/react-native-ffmpeg</a></p>\n<p>项目主人就是开发 <code class=\"language-text\">mobile-ffmpeg</code> 的大佬，真的膜拜。FFmpeg（<a href=\"https://www.ffmpeg.org/\">官网</a>） 是个完整的跨平台解决方案，用于录制、转换和流式传输音频和视频。可以安装到命令行，在终端当作指令使用。</p>\n<p>这个项目相当于把大部分电脑指令移植到了移动端。比如，解码 MJPEG 视频流。（正在研究中）</p>\n<h2>react-native-fs</h2>\n<p>项目地址：<a href=\"https://github.com/itinance/react-native-fs\">https://github.com/itinance/react-native-fs</a></p>\n<p>这是个著名的文件读写库。有了它就可以进行移动端文件的增删改查了。</p>\n<h2>目前的解决方案</h2>\n<p>在一个周期内，用 <code class=\"language-text\">react-native-fs</code> 下载一张视频流的截图，然后用这个下载的 path 作为 input，输入 <code class=\"language-text\">tflite-react-native</code> 的方法，进行预测后将返回结果打在公屏上。</p>\n<p>对于一张 50kb 左右的图片来说，安卓需要 0.4s 左右， iOS 需要 1s 左右（等待优化 ⌛️）。</p>\n<p>附：</p>\n<p>2021.8.24 项目进展</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/548ea0ed774ae32a5996a19ec437583f/f726e/status0824.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAC/0lEQVQozx2O229TBQCHD8223lzbcdqul/V0vYxezqHdWE/b9d61naVdM3Fsy5oGJxkbONRKwAFGEBJEcMYQ9YGEucUMDEtMJDwbw4NvsMiDEeKT8Q/5DH345fu+t5+g1WoxGo29GQwG9Do9g4ODiKKIXm9A13cIrSCg69PwltHAYYuBYXEA8XA/oqWfj0bs3JqI0hJNCBoNgslkQvNGBKFHnU7Xc+GQhgFBwB0vIC3fwKtk0Gr7Wfc62atM8jAToRqVMJ3ZwnFpF23lNLr+PgSLxcLCiXe4/fln5DMZzBYLnU6Hy1eucrxaxixnca7cRpos03FZuCAHqYx6GPf7iMWCjKx+TfDjb5EX1nDbzAhWq5Vut8v+/j5zc3OYTeZeb29v02g2ey+HjXqCNjv3jwb4KeZHdQ9jCwdx+NyMzG7gO/cV4ngWk92O4PF4qFartNttkskkTo+D2kyNxcVF3l9ZQY4ruBQ3tpCdkUgEr+Tlrt/LH4UMJ+1mTIWTSJ0bNDw2pl02BEmS+OH773j9+m82Nj7A6hDZ2XnAy5cHPPvtd6bn08h3hlC3HERkL2P+AO/WfayvBcgkncghH/Ejozw6u8re+mmE4FgY85CLAb0Fp8vD2JsWRxlySgzaJPz+EPnpFMGYTMQvEwvLWLsSw9+4GSp5iY4liMbjRG/+SPSLbYRsMszq0gRr7RQZNUytnODa2TDXP0xx87zC8pxCpTLFldU4m2vHaLwd45PFIJdORfj0VIDllkJUUVi6pTB/PYTQafl49TjAnw8j1ItHaM5M8XzXx4tHSf57GmHrQphWfZJ/npQ5+LnI+ffiHOw4efXYx7+/uri3GSJ8NMHVDYXN9SjC+PgEajLDuWWZu90Qdy6m+PJigTPtNGrhOLnZEqX5HIlGHrVRIFspEkvkUdMlcrkalWyReiFHpVimWqwgpNMpjk0muXd5gud7cZ7tlPnrlya711TKpSylJZXCgkp+ViXfVMnWVXIzKplimplajmo6yWxpioVWjflmlf8BOzmBFY90o5AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"status0824\"\n        title=\"status0824\"\n        src=\"/static/548ea0ed774ae32a5996a19ec437583f/f058b/status0824.png\"\n        srcset=\"/static/548ea0ed774ae32a5996a19ec437583f/c26ae/status0824.png 158w,\n/static/548ea0ed774ae32a5996a19ec437583f/6bdcf/status0824.png 315w,\n/static/548ea0ed774ae32a5996a19ec437583f/f058b/status0824.png 630w,\n/static/548ea0ed774ae32a5996a19ec437583f/40601/status0824.png 945w,\n/static/548ea0ed774ae32a5996a19ec437583f/78612/status0824.png 1260w,\n/static/548ea0ed774ae32a5996a19ec437583f/f726e/status0824.png 2610w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>2020.9.3 项目进展</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c0bc7d57a85dcee69284c29704caca1c/b918a/status0903.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.53164556962025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB4ElEQVQoz4WRy2sTURSHz8y9dx5J5pFJJklDatuNFB8FSZethCBVaKHtwqIrhYqiCxeCxEVRF7oSlCJuRcRFNoLrIq4kBAL+Fe78Iz6ZaRpiaevi41zOuef5kyRJKJfLxHFMpVLJ30opRGSCNWbapzMswRyP1et1arUa1WqVNE1pNptorbCVwrge2vUxGY6D7zl50lZR82O2xNcZn++tEk8Sb9JY5FhnZRwiI+jOLvrVL8z9T1h7P5HNPcJQcMKQBS2sWcJOPWDDExana3S7XTqdTk673aYUBKRJjFTnkMvXUYtXsS6tYeaWaKQpUamIJLPIlXXM8npupXURR9v5VjIYDBgOh4xGI/r9Po1Gg3IYE4UhynHzVbXr4XoeUTmhYAuFzh383gHewy8UegfojR5KBOO4SBRFuRAZQSnAKfiERUFfe4R8+IM8/obs/8a6/QZXhPn5BcQrINpDwhhJA0Q7OMYcifnvDTNsLYjxUdVzzFxYRpIW4keHR7dsVlyL/YrhZa3A+4bHrUAjYp0sSpaQ2/Mr6JuvibeeorZfIO1t7PGfVV/xLvV4VnZ4W3XZKenTVZ4UXLqBPPiMbD5H7n1EVu8eJh3FT+ckp8VZ/mwSewrr/wXHydk01pQ9e7Kcv21EFHII0leOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"status0903\"\n        title=\"status0903\"\n        src=\"/static/c0bc7d57a85dcee69284c29704caca1c/f058b/status0903.png\"\n        srcset=\"/static/c0bc7d57a85dcee69284c29704caca1c/c26ae/status0903.png 158w,\n/static/c0bc7d57a85dcee69284c29704caca1c/6bdcf/status0903.png 315w,\n/static/c0bc7d57a85dcee69284c29704caca1c/f058b/status0903.png 630w,\n/static/c0bc7d57a85dcee69284c29704caca1c/40601/status0903.png 945w,\n/static/c0bc7d57a85dcee69284c29704caca1c/78612/status0903.png 1260w,\n/static/c0bc7d57a85dcee69284c29704caca1c/b918a/status0903.png 2780w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","frontmatter":{"title":"React Native: IP Camera LiveStream Prediction","date":"September 03, 2021","description":"React Native 实战项目：在移动端实现 Mjpeg Stream 的图像分类（tensorflow） 持续更新"}},"previous":{"fields":{"slug":"/Life/peking-2021-summer/"},"frontmatter":{"title":"Coding in Beijing"}},"next":{"fields":{"slug":"/Research/image-style-transfer/"},"frontmatter":{"title":"Image Style Transfer Using Convolutional Neural Networks"}}},"pageContext":{"id":"eea0b30f-91cd-5c7e-8a15-0ce5d1671634","previousPostId":"152ca637-5d75-5d8b-ba99-c6c39a6827a5","nextPostId":"8a88f3e8-ac93-5dcd-9302-813163e8e2e3"}},
    "staticQueryHashes": ["2841359383","3257411868"]}